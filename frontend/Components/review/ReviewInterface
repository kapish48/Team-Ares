import React, { useState } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { CheckCircle, XCircle, AlertCircle, ExternalLink } from 'lucide-react';
import { toast } from 'sonner';

export default function ReviewInterface({ 
  authRequest, 
  patientCase, 
  reviewItem,
  onApprove, 
  onDeny, 
  onRequestInfo,
  isLoading 
}) {
  const [reviewerNotes, setReviewerNotes] = useState('');
  const [decision, setDecision] = useState(null);

  const handleSubmit = async (finalDecision) => {
    if (!reviewerNotes.trim()) {
      toast.error('Please provide reviewer notes');
      return;
    }

    setDecision(finalDecision);

    try {
      if (finalDecision === 'approved') {
        await onApprove(reviewerNotes);
      } else if (finalDecision === 'denied') {
        await onDeny(reviewerNotes);
      }
      toast.success(`Case ${finalDecision}`);
    } catch (error) {
      toast.error('Failed to submit review');
      setDecision(null);
    }
  };

  return (
    <Card className="border-2 border-amber-200 bg-amber-50/30">
      <CardHeader className="bg-amber-50 border-b border-amber-200">
        <CardTitle className="text-lg flex items-center gap-2">
          <AlertCircle className="w-5 h-5 text-amber-600" />
          Human Review Required
        </CardTitle>
      </CardHeader>
      <CardContent className="p-6 space-y-6">
        {/* Flag Reason */}
        <div className="p-4 bg-white rounded-lg border border-amber-200">
          <h4 className="font-semibold text-sm text-slate-700 mb-2">Flag Reason:</h4>
          <p className="text-sm text-slate-600">{reviewItem?.flag_reason}</p>
        </div>

        {/* AI Preliminary Decision */}
        <div className="p-4 bg-white rounded-lg border border-slate-200">
          <h4 className="font-semibold text-sm text-slate-700 mb-3">AI Preliminary Assessment:</h4>
          <div className="flex items-center gap-3 mb-3">
            <Badge className={`${
              authRequest.ai_decision === 'approved' ? 'bg-green-100 text-green-800' :
              authRequest.ai_decision === 'denied' ? 'bg-red-100 text-red-800' :
              'bg-amber-100 text-amber-800'
            } border`}>
              AI Recommendation: {authRequest.ai_decision?.toUpperCase()}
            </Badge>
            <span className="text-sm text-slate-600">
              Confidence: <span className="font-bold">{authRequest.confidence_score}%</span>
            </span>
          </div>
          <p className="text-sm text-slate-600 leading-relaxed">
            {authRequest.decision_rationale}
          </p>
        </div>

        {/* Clinical Documents Link */}
        {patientCase?.clinical_notes_url && (
          <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
            <a 
              href={patientCase.clinical_notes_url} 
              target="_blank" 
              rel="noopener noreferrer"
              className="flex items-center gap-2 text-blue-600 hover:text-blue-800 font-medium"
            >
              <ExternalLink className="w-4 h-4" />
              View Original Clinical Documents
            </a>
          </div>
        )}

        {/* Extracted Evidence */}
        {authRequest.evidence_extracted && (
          <div className="p-4 bg-white rounded-lg border border-slate-200">
            <h4 className="font-semibold text-sm text-slate-700 mb-2">Extracted Evidence:</h4>
            <pre className="text-xs text-slate-600 whitespace-pre-wrap">
              {JSON.stringify(authRequest.evidence_extracted, null, 2)}
            </pre>
          </div>
        )}

        {/* Reviewer Notes */}
        <div>
          <label className="block text-sm font-semibold text-slate-700 mb-2">
            Your Review Notes *
          </label>
          <Textarea
            value={reviewerNotes}
            onChange={(e) => setReviewerNotes(e.target.value)}
            placeholder="Provide your clinical assessment and rationale for your decision..."
            className="min-h-32"
          />
        </div>

        {/* Action Buttons */}
        <div className="flex gap-3">
          <Button
            onClick={() => handleSubmit('approved')}
            disabled={isLoading || decision !== null}
            className="flex-1 bg-green-600 hover:bg-green-700"
          >
            <CheckCircle className="w-4 h-4 mr-2" />
            Approve Authorization
          </Button>
          <Button
            onClick={() => handleSubmit('denied')}
            disabled={isLoading || decision !== null}
            className="flex-1 bg-red-600 hover:bg-red-700"
            variant="destructive"
          >
            <XCircle className="w-4 h-4 mr-2" />
            Deny Authorization
          </Button>
        </div>

        <p className="text-xs text-slate-500 text-center">
          Your decision will be logged for AI training and quality assurance
        </p>
      </CardContent>
    </Card>
  );
}