import React, { useState } from 'react';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from "@/components/ui/button";
import { FileText, Loader2, CheckCircle } from 'lucide-react';
import { toast } from 'sonner';
import { createPageUrl } from '@/utils';

export default function GenerateAuditButton({ authRequest }) {
  const queryClient = useQueryClient();
  const [generated, setGenerated] = useState(!!authRequest.audit_pdf_url);

  const generateAuditMutation = useMutation({
    mutationFn: async () => {
      // Generate audit report URL
      const auditReportUrl = `${window.location.origin}${createPageUrl(`AuditReport?id=${authRequest.id}`)}`;

      // Update authorization request with audit URL
      await base44.entities.AuthorizationRequest.update(authRequest.id, {
        audit_pdf_url: auditReportUrl,
        workflow_stage: 'completed'
      });

      return auditReportUrl;
    },
    onSuccess: (url) => {
      queryClient.invalidateQueries(['authRequest']);
      setGenerated(true);
      toast.success('Audit report generated successfully');
      
      // Open audit report in new tab
      setTimeout(() => {
        window.open(url, '_blank');
      }, 500);
    },
    onError: (error) => {
      toast.error(`Failed to generate audit report: ${error.message}`);
    }
  });

  if (generated && authRequest.audit_pdf_url) {
    return (
      <Button 
        variant="outline" 
        className="bg-green-50 border-green-300 text-green-700 hover:bg-green-100"
        onClick={() => window.open(authRequest.audit_pdf_url, '_blank')}
      >
        <CheckCircle className="w-4 h-4 mr-2" />
        View Audit Report
      </Button>
    );
  }

  return (
    <Button 
      onClick={() => generateAuditMutation.mutate()}
      disabled={generateAuditMutation.isPending}
      className="bg-purple-600 hover:bg-purple-700"
    >
      {generateAuditMutation.isPending ? (
        <>
          <Loader2 className="w-4 h-4 mr-2 animate-spin" />
          Generating...
        </>
      ) : (
        <>
          <FileText className="w-4 h-4 mr-2" />
          Generate Audit Report
        </>
      )}
    </Button>
  );
}