import React, { useEffect, useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Button } from "@/components/ui/button";
import { Skeleton } from "@/components/ui/skeleton";
import { ArrowLeft, Download, Printer } from 'lucide-react';
import { Link } from 'react-router-dom';
import { createPageUrl } from '@/utils';
import AuditReportTemplate from '../components/audit/AuditReportTemplate';

export default function AuditReport() {
  const urlParams = new URLSearchParams(window.location.search);
  const requestId = urlParams.get('id');
  const [isPrinting, setIsPrinting] = useState(false);

  const { data: authRequest, isLoading: loadingAuth } = useQuery({
    queryKey: ['authRequest', requestId],
    queryFn: () => base44.entities.AuthorizationRequest.filter({ id: requestId }),
    select: (data) => data[0],
    enabled: !!requestId
  });

  const { data: patientCase, isLoading: loadingCase } = useQuery({
    queryKey: ['patientCase', authRequest?.patient_case_id],
    queryFn: () => base44.entities.PatientCase.filter({ id: authRequest.patient_case_id }),
    select: (data) => data[0],
    enabled: !!authRequest?.patient_case_id
  });

  const { data: policy } = useQuery({
    queryKey: ['policy', authRequest?.policy_id],
    queryFn: () => base44.entities.PolicyRule.filter({ id: authRequest.policy_id }),
    select: (data) => data[0],
    enabled: !!authRequest?.policy_id
  });

  const handlePrint = () => {
    setIsPrinting(true);
    setTimeout(() => {
      window.print();
      setIsPrinting(false);
    }, 100);
  };

  useEffect(() => {
    // Add print-specific styles
    const style = document.createElement('style');
    style.innerHTML = `
      @media print {
        body * {
          visibility: hidden;
        }
        #audit-report-content, #audit-report-content * {
          visibility: visible;
        }
        #audit-report-content {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }
        .no-print {
          display: none !important;
        }
        @page {
          margin: 1cm;
        }
      }
    `;
    document.head.appendChild(style);
    return () => {
      document.head.removeChild(style);
    };
  }, []);

  if (loadingAuth || loadingCase) {
    return (
      <div className="min-h-screen bg-white p-8">
        <div className="max-w-5xl mx-auto space-y-6">
          <Skeleton className="h-32" />
          <Skeleton className="h-64" />
          <Skeleton className="h-48" />
        </div>
      </div>
    );
  }

  if (!authRequest) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-6 flex items-center justify-center">
        <div className="text-center">
          <h2 className="text-2xl font-bold text-slate-900 mb-4">Authorization Request Not Found</h2>
          <Link to={createPageUrl('Dashboard')}>
            <Button>Return to Dashboard</Button>
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50">
      {/* Action Bar - Hidden when printing */}
      <div className="no-print bg-white border-b border-slate-200 shadow-sm sticky top-0 z-10">
        <div className="max-w-5xl mx-auto px-6 py-4">
          <div className="flex items-center justify-between">
            <Link to={createPageUrl(`CaseDetail?id=${authRequest.id}`)}>
              <Button variant="ghost">
                <ArrowLeft className="w-4 h-4 mr-2" />
                Back to Case
              </Button>
            </Link>
            <div className="flex gap-3">
              <Button onClick={handlePrint} variant="outline" disabled={isPrinting}>
                <Printer className="w-4 h-4 mr-2" />
                Print / Save as PDF
              </Button>
              <Button onClick={handlePrint} className="bg-blue-600 hover:bg-blue-700" disabled={isPrinting}>
                <Download className="w-4 h-4 mr-2" />
                Download Audit Report
              </Button>
            </div>
          </div>
        </div>
      </div>

      {/* Audit Report Content */}
      <div className="max-w-5xl mx-auto px-6 py-8">
        <div id="audit-report-content" className="bg-white shadow-lg rounded-lg p-12 print:shadow-none print:rounded-none">
          <AuditReportTemplate 
            authRequest={authRequest}
            patientCase={patientCase}
            policy={policy}
          />
        </div>

        {/* Print Instructions - Hidden when printing */}
        <div className="no-print mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
          <h3 className="font-semibold text-blue-900 mb-2">ðŸ“„ How to Save as PDF</h3>
          <div className="text-sm text-blue-800 space-y-1">
            <p>â€¢ Click "Print / Save as PDF" button above</p>
            <p>â€¢ In the print dialog, select "Save as PDF" or "Microsoft Print to PDF" as the printer</p>
            <p>â€¢ Choose destination and click Save</p>
            <p className="mt-3 text-xs text-blue-700">
              ðŸ’¡ <strong>Pro Tip:</strong> The PDF will be automatically formatted for professional healthcare documentation standards.
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}